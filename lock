#!/bin/bash

set +x

cd $(dirname $(realpath $0))

check_locked() {
    sleep 1
    pgrep i3lock >/dev/null && LOCKED=true || LOCKED=false
    [[ $LOCKED == true ]] && return 0 || return 1
}
log() {
    echo `date` "$*" | tee -a /tmp/locker.log
}

run() {
    # 1. Lock
    # Try i3lock-color fallback to i3lock
    log "Locking"
    LOCKED=true
    i3lock \
        --blur=5 \
        --nofork \
        --ringcolor=$(xrdb_q color7)ff \
        --insidecolor=$(xrdb_q color8)aa \
        --timecolor=$(xrdb_q color0)ff \
        --keyhlcolor=$(xrdb_q color15)ff \
        --bshlcolor=$(xrdb_q color1)ff \
        --ringvercolor=$(xrdb_q color12)ff \
        --insidevercolor=$(xrdb_q color4)dd \
        --verifcolor=$(xrdb_q color0)ee \
        --ringwrongcolor=$(xrdb_q color1)ff \
        --insidewrongcolor=$(xrdb_q color9)dd &

    [[ ! $(pgrep -x i3lock) ]] && {
        scrot /tmp/lock.pre.png
        convert /tmp/lock.pre.png -scale 10% -scale 1000% /tmp/lock.png
        rm /tmp/lock.pre.png
        i3lock \
            --nofork \
            --image=/tmp/lock.png &
    }
    while [[ ! $(pgrep i3lock) ]]; do log "waiting for i3lock"; sleep 1; done

    log "Preparing Lock"

    # 2. Run lock hooks
    log "Running pre-lock hooks:"
    for hook in ./lock.d/**; do
        hook_name=$(basename $hook)
        log "  $hook"
        $hook lock | tee /tmp/locker.$hook_name.log &
    done

    # 3. Wait till unlocked
    while [[ $(pgrep -x i3lock) ]]; do sleep 1; done

    LOCKED=false

    log "Unlocked"

    # 4. Run post-unlock hooks
    log "Running post-unlock hooks:"
    for hook in ./lock.d/**; do
        log "  $hook"
        $hook unlock | tee -a /tmp/locker.$hook.log &
    done

    log "Done"
}

[[ "${BASH_SOURCE[0]}" == "${0}" ]] && run | tee /dev/null
